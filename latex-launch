#!/bin/bash

set -euo

FILE_NAME=unset
OUT_DIR=unset
ENGINE="pdflatex"
USE_BIBER="no"

SHORT=n:,o:,b::,e:
LONG=file-name:,out-dir:,use-biber::,engine:
OPTS=$(getopt -a -n latex-launch --options $SHORT --longoptions $LONG -- "$@")

if [ "$#" -eq 0 ]; then
    echo "Usage: latex-launch 
                [ -n | --file-name ]
                [ -o | --out-dir   ]
                [ -b | --use-biber ]
                [ -e | --engine    ]"
    exit 2
fi

eval set -- "$OPTS"
while :
do
  case "$1" in
    -n | --file-name)
        FILE_NAME="$2"
        shift 2
        ;;
    -o | --out-dir)
        OUT_DIR="$2"
        shift 2
        ;;
    -b | --use-biber)
        USE_BIBER="$2"
        shift 2
        ;;
    -e | --engine)
        ENGINE="$2"
        shift 2
        ;;
    --)
      shift;
      break
      ;;
    *)
      echo "Unexpected option: $1"
      ;;
  esac
done

echo "[INFO] RUNNING WITH THIS PARAMETERS:
{
    file name: $FILE_NAME, 
    output_dir: $OUT_DIR, 
    using_biber: $USE_BIBER,
    engine:      $ENGINE
}"

# -interaction=batchmode
LATEX_ARG="-shell-escape -output-directory=$OUT_DIR $FILE_NAME.tex"

$ENGINE $LATEX_ARG

if [ "$USE_BIBER" != "no" ]; then
    biber -output-directory=$OUT_DIR -input-directory=$OUT_DIR $FILE_NAME
    $ENGINE $LATEX_ARG 
fi

